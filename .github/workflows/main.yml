# This is a basic workflow to help you get started with Actions
name: Package Rocketchat

# Controls when the workflow will run
on: [push,workflow_dispatch]
# Allows you to run this workflow manually from the Actions tab

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  
  create_latest:
    name: Create latest files
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Get latest version
      run: |
        VER=$(curl https://api.github.com/repos/RocketChat/Rocket.Chat.Electron/releases/latest | jq '.["tag_name"]' | tr -d \")
        echo "version=$VER" >> $GITHUB_ENV
    - name: Get file hash
      run: |
        VERSION=${{ env.version }}
        wget https://github.com/RocketChat/Rocket.Chat.Electron/releases/download/${{ env.version }}/rocketchat-${{ env.version }}-win-x64.exe
        HASH=$(sha256sum rocketchat-${{ env.version }}-win-x64.exe | awk "{print \$1}")
        echo "hash=$HASH" >> $GITHUB_ENV

    - name: Make install script
      run: |
        mkdir -p latest/tools/
        echo echo <<EOF > latest/tools/chocolateyinstall.ps1
        "$ErrorActionPreference = 'Stop';" 
        "Install-ChocolateyPackage -packageName 'rocketchat' -FileType exe -SilentArgs '/S /allusers' -Url 'https://github.com/RocketChat/Rocket.Chat.Electron/releases/download/${{ env.version }}/rocketchat-${{ env.version }}-win-x64.exe' -checksum '${{ env.hash }}' -checksumType 'sha256'" 
        EOF

    - name: Make nuspec
      run: |
        echo <<EOF > latest/rocketchat.nuspec
        <?xml version="1.0" encoding="utf-8"?>
        <package xmlns="http://schemas.microsoft.com/packaging/2015/06/nuspec.xsd">
          <metadata>
            <id>rocketchat</id>
            <version>${{ env.version }}</version>
            <packageSourceUrl>https://github.com/Sierra1011/chocolateypackage-rocketchat</packageSourceUrl>
            <owners>Sierra1011</owners>
            <title>Rocket.Chat</title>
            <authors>Rocket.Chat</authors>
            <projectUrl>https://rocket.chat/ </projectUrl>
            <iconUrl>https://github.com/RocketChat/Rocket.Chat.Artwork/blob/master/Logos/icon.svg</iconUrl>
            <licenseUrl>https://github.com/RocketChat/Rocket.Chat.Electron/blob/develop/LICENSE</licenseUrl>
            <requireLicenseAcceptance>true</requireLicenseAcceptance>
            <projectSourceUrl>https://github.com/RocketChat/Rocket.Chat.Electron</projectSourceUrl>
            <mailingListUrl>https://rocket.chat/contact</mailingListUrl>
            <bugTrackerUrl>https://github.com/RocketChat/Rocket.Chat.Electron/issues</bugTrackerUrl>
            <tags>rocket.chat rocketchat rocket.chat+ admin chat IM</tags>
            <summary>Official OSX, Windows, and Linux Desktop Clients for Rocket.Chat https://rocket.chat/ </summary>
            <description>
        The ultimate Free Open Source Solution for team communications. 
        Rocket.Chat is free, unlimited and open source. Replace email, HipChat and Slack with the ultimate team chat software solution.
        Communicate and collaborate using team chat and switch to video or audio calls with screen sharing for more efficient teamwork.
        Improve productivity by discussing and sharing ideas, projects and files with real-time or asynchronous team chat.
        With complete access to the source code, you can fully customize, extend or add new functionality to meet your requirements.
        With Rocket.Chat LiveChat you can add real-time chat widgets to any website or mobile app and get more value from your team chat.
        Replace other systems and use one communication platform to save time and money. 
            </description>
            <releaseNotes>

            Release notes found here: https://github.com/RocketChat/Rocket.Chat.Electron/releases/tag/${{ env.version }}

            </releaseNotes>
          </metadata>
          <files>
            <file src="tools\**" target="tools" />
          </files>
        </package>
        EOF 
    - name: Upload latest
      uses: actions/upload-artifact@v3
      with:
        name: latest
        path: latest/

  build:
    name: Chocolatey Build
    #needs: ["create_latest"]
    runs-on: windows-2019
    defaults:
      run:
        working-directory: ~/Downloads/
    steps:
    - uses: actions/checkout@v3
    
    - name: Download latest files
      uses: actions/download-artifact@v3
      with:
        name: latest
        path: C:\Users\runneradmin\Downloads

    - name: Display structure of downloaded files
      run: ls -R
      working-directory: C:\Users\runneradmin\Downloads
      
    - name: Choco Package 
      uses: crazy-max/ghaction-chocolatey@v2
      with:
        args: pack C:\Users\runneradmin\Downloads\rocketchat.nuspec --output-directory C:\Users\runneradmin\Downloads\
    
    - name: Rename file
      run: mv rocketchat.${{ env.version }}.nupkg rocketchat.nupkg

    - name: Choco add API key
      uses: crazy-max/ghaction-chocolatey@v2
      with:
        args: apikey -k ${{ secrets.CHOCO_TOKEN }} --source https://push.chocolatey.org/

    - name: Push to Chocolatey
      uses: crazy-max/ghaction-chocolatey@v2
      with:
        args: push C:\Users\runneradmin\Downloads\rocketchat.nupkg


#
#      - name: Install AU
#        run: cinst au
#      - name: Build Package
#        working-directory: ./dolt
#        run: |
#          ./update.ps1
#        env:
#          au_Push: 'false'
#          au_Force: ${{ github.event.inputs.force }}
#          VERSION: ${{ needs.get-version.outputs.version }}
#      - name: Test Package Installer
#        working-directory: ./dolt
#        run: Test-Package $Install
#      - name: Dolt Version
#        run: |
#          refreshenv
#          $env:Path += ';C:\Program Files\Dolt\bin\'
#          dolt version
#      - uses: EndBug/add-and-commit@v7
#        with:
#          message: "[ga-bump-dolt-chocolatey] Bumping Dolt on Chocolatey ${{ needs.get-version.outputs.version }}"
#          add: "."
#          cwd: "."
#      - name: Push Package to Chocolatey
#        run: Push-Package
#        working-directory: ./dolt
#        env:
#          api_key: ${{ secrets.CHOCO_API_KEY }}
#          au_Force: ${{ github.event.inputs.force }}